'*******************************************************************************
'**   Created by Peter Horsbøll Møller, Precisely
'** 	Program:
'** 	Modul:
'**
'*******************************************************************************

'-------------------------------------
Include "Library\MapBasic.def"
Include "Enums.def"
Include "Library\Icons.def"
Include "Library\Menu.def"
'**default constants...
Include "Library\Defaults.def"

Define xProgram 		"MapInfo2Excel"
Define xProgramMenu		"MapInfo2Excel"
Define xVersion 		"2.4.3"
Define xYear			"2022"
Define xAddToMenuBar	FALSE

Define FILE_INI			xProgram & ".ini"
Define FILE_DBG			ApplicationDirectory$() & xProgram & ".dbg"
'Define FILE_DLL			ApplicationDirectory$() & xProgram & ".dll"
Define FILE_HLP			ApplicationDirectory$() & "Documentation\" & xProgram 	'& ".pdf", will be added depending on the language used
Define FILE_PAD			GetFolderPath$(FOLDER_MI_PREFERENCE) & xProgram & ".btp"
Define PATH_IMAGES			ApplicationDirectory$() & "Images\"
Define PATH_STRINGS			ApplicationDirectory$() & "Strings\"

Define					WORKSHEET_INPUT_DATA	"InputData"
Define					WORKSHEET_INPUT_MAPS	"Maps"

Define CTRL_LST_TABLES		100
Define CTRL_CHK_EXPORT_TITLES	200
Define CTRL_TXT_OUTPUT_FILE	300
Define CTRL_TXT_WAIT_TIME	400

'-------------------------------------
Include "Library\ProgramInfo.def"
Include "Library\ARRAYLib.def"
Include "Library\CONFIGFILELib.def"
Include "Library\DEBUGLib.def"
Include "Library\DATETIMELib.def"
Include "Library\ERRORLib.def"
Include "Library\EXCELLib.def"
Include "Library\FILELib.def"
Include "Library\MAPPERLib.def"
Include "Library\RIBBONLib.def"
Include "Library\RESSTRNGLib.def"
Include "Library\STRINGLib.def"
Include "Library\TABLELib.def"

Include "LanguageStrings.def"

'-----------------------------------------------------------------------------------------
Declare Sub Main
Declare Sub EndProgram

Declare Sub Endhandler
Declare Sub WinFocusChangedHandler
Declare Sub WinClosedHandler
Declare Sub MENUWinCreatedHandler(ByVal args as This)
Declare Sub MENUTableOpenedHandler(ByVal args as This)
Declare Sub MENUWorkspaceOpenedHandler(ByVal args as This)
Declare Sub MENUTableClosedHandler(ByVal args as This)
Declare Sub MENUAllClosedHandler(ByVal args as This)
Declare Sub EnableDisableGUI

Declare Sub MENUBuildRibbonInterface

Declare Sub MENUWriteConfigFile
Declare Sub MENUReadConfigFile

Declare Sub MENUGoToCommunityDownloads

Declare Function MENUGetExcelTemplateFile() As String

Declare Sub AddIn_DefaultCommand
Declare Sub MENUExportTableToExcel
Declare Sub MENUExportTableXLS_OKButton

Declare Sub MENUExportBrowserDataToExcel
Declare Sub MENUExportBrowserData_OKButton

Declare Sub MENUExport_SaveFileAs

Declare Sub MENUExportTable(ByVal sTab As String, ByVal bExportTitles As Logical, ByVal sOutputFile As String)
Declare Sub MENUExportTableViaCSV(ByVal sTab As String, ByVal bExportTitles As Logical, ByVal sOutputFile As String)
Declare Sub MENUExportTableCSV(ByVal sTab As String, ByVal bExportTitles As Logical, ByVal sOutputFile As String)

Declare Sub MENUExportMapWindowToExcel
Declare Function MENUExportMapToExcelIsEnabled() As Logical

Dim	marrTables() As String,
	msLatestExcelFile As String,
	mnNumMapExported As Integer,
	mbExportTitles As Logical,
	msLanguage As String
'**********************************************************************************************''
'**   Created by Peter Horsbøll Møller, Precisely
'
'**********************************************************************************************''
Sub Main

OnError GoTo ErrorOccured

	'***Initializing ApplicationInfo
	Call PRGISetApplicationName(xProgram)
	Call PRGISetApplicationVersion(xVersion)
	Call PRGISetApplicationCopyrightYear(xYear)
	Call PRGISetApplicationDevelopedBy("Peter Horsbøll Møller")
	Call PRGISetApplicationImageUri(PATH_IMAGES & "MapWindowExcel_16.png")

	'***Enabling Debug if file exists
	Call DEBUGEnableByFile(FILE_DBG)

	Call MENUReadConfigFile

	Call RESSTRNGSetCharSet("UTF-8")
	Call RESSTRNGSetStringFilesFolder(PATH_STRINGS)
	Call PRGISetApplicationUseLanguageCode(TRUE)
	Call PRGILoadLanguageStrings(msLanguage)

	If FileExists(FILE_HLP & " " & PRGIGetApplicationLanguageName() & ".PDF") Then
		Call PRGISetApplicationHelpFile(FILE_HLP & " " & PRGIGetApplicationLanguageName() & ".PDF")
	Else
		Call PRGISetApplicationHelpFile(FILE_HLP & ".PDF")
	End If


	If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
		Call MENUBuildRibbonInterface
		Call EnableDisableGUI
	Else
		Create Menu xProgramMenu As
			RESSTRNGGetString(STR_MNU_EXPORT_TAB_TO_XLS)
				HelpMsg ""
				Calling MENUExportTableToExcel,
			RESSTRNGGetString(STR_MNU_EXPORT_BROWSER_TO_XLS)	'"Export current browser data to MS Excel..."
				HelpMsg ""
				Calling MENUExportBrowserDataToExcel,
			RESSTRNGGetString(STR_MNU_EXPORT_MAP_TO_XLS)		'"Export map window to MS Excel"
				Calling MENUExportMapWindowToExcel,
			"(-",
'			RESSTRNGGetString(STR_MNU_RATE_APPLICATION) 		'"Rate the application at Community Downloads"
'				Calling MENUGoToCommunityDownloads,
			RESSTRNGGetString(STR_MNU_END_APPLICATION)		'"End program"
				Calling EndProgram,
			RESSTRNGGetString(STR_MNU_ABOUT_APPLICATION)		'"About..."
				Calling PRGIAboutbox

		Alter Menu ID 4
			Add "(-", xProgramMenu  As xProgramMenu

		Alter Menu ID 47 Add
			RESSTRNGGetString(STR_MNU_EXPORT_BROWSER_TO_XLS)
				HelpMsg ""
				Calling MENUExportBrowserDataToExcel
	End If

	Alter Menu ID M_SHORTCUT_MAPPER Add
		"(-",
		RESSTRNGGetString(STR_MNU_EXPORT_MAP_TO_XLS)
			Calling MENUExportMapWindowToExcel

	Alter Menu ID M_SHORTCUT_BROWSER Add
		"(-",
		RESSTRNGGetString(STR_MNU_EXPORT_BROWSER_TO_XLS)
			HelpMsg ""
			Calling MENUExportBrowserDataToExcel

	mbExportTitles	= TRUE

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "Main")
	Call ERRShow()

End Sub

'****************************************
'**   Created by Peter Horsbøll Møller, Precisely
'**   Ending MapBasic application
'****************************************
Sub EndProgram

OnError GoTo ErrorOccured

	End Program
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "EndProgram")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub Endhandler

OnError GoTo ErrorOccured

	Call MENUWriteConfigFile
	If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
		Call RBNEndHandler
	End If
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "Endhandler")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub WinFocusChangedHandler

Dim	nWID As Integer

OnError GoTo ErrorOccured

	Call DEBUGPrint("WinFocusChangedHandler")
	If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
		nWID = FrontWindow()
		If nWID <> 0 Then
			Do Case WindowInfo(nWID, WIN_INFO_TYPE)
				Case WIN_MAPPER
					If msLatestExcelFile <> "" Then
						Call RBNGroupEnableControls("", "", "exportMapToExcel", TRUE)
					End If
					Call RBNGroupEnableControls("", "", "exportBrowserToExcel", FALSE)
				Case WIN_BROWSER
					Call RBNGroupEnableControls("", "", "exportMapToExcel", FALSE)
					Call RBNGroupEnableControls("", "", "exportBrowserToExcel", TRUE)
				Case Else
					Call RBNGroupEnableControls("", "", "exportMapToExcel", FALSE)
					Call RBNGroupEnableControls("", "", "exportBrowserToExcel", FALSE)
			End Case
		End If
	End If
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "WinFocusChangedHandler")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub WinClosedHandler

OnError GoTo ErrorOccured

	Call DEBUGPrint("WinClosedHandler")
	If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
		If NumWindows() <= 1 Then
			Call RBNGroupEnableControls("", "", "exportMapToExcel", FALSE)
			Call RBNGroupEnableControls("", "", "exportBrowserToExcel", FALSE)
		Else
			Call EnableDisableGUI
		End If
	End If
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "WinClosedHandler")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUWinCreatedHandler(ByVal args as This)

Dim	sTableName As String

OnError GoTo ErrorOccured

	Call DEBUGPrint("MENUWinCreatedHandler")
	If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
		If NumWindows() = 0 Then
			Call RBNGroupEnableControls("", "", "exportMapToExcel", FALSE)
			Call RBNGroupEnableControls("", "", "exportBrowserToExcel", FALSE)
'			Call RBNGroupEnableControl("TabMap", "MapClipboard", "exportMapToExcel", FALSE)
'			Call RBNGroupEnableControl("TabTable", "TableData", "exportBrowserToExcel", FALSE)
		Else
			Do Case WindowInfo(FrontWindow(), WIN_INFO_TYPE)
				Case WIN_MAPPER
					If msLatestExcelFile <> "" Then
						Call RBNGroupEnableControls("", "", "exportMapToExcel", TRUE)
					End If
					Call RBNGroupEnableControls("", "", "exportBrowserToExcel", FALSE)
'					Call RBNGroupEnableControl("TabMap", "MapClipboard", "exportMapToExcel", TRUE)
'					Call RBNGroupEnableControl("TabTable", "TableData", "exportBrowserToExcel", FALSE)
				Case WIN_BROWSER
					Call RBNGroupEnableControls("", "", "exportMapToExcel", FALSE)
					Call RBNGroupEnableControls("", "", "exportBrowserToExcel", TRUE)
'					Call RBNGroupEnableControl("TabMap", "MapClipboard", "exportMapToExcel", FALSE)
'					Call RBNGroupEnableControl("TabTable", "TableData", "exportBrowserToExcel", TRUE)
				Case Else
					Call RBNGroupEnableControls("", "", "exportMapToExcel", FALSE)
					Call RBNGroupEnableControls("", "", "exportBrowserToExcel", FALSE)
'					Call RBNGroupEnableControl("TabMap", "MapClipboard", "exportMapToExcel", FALSE)
'					Call RBNGroupEnableControl("TabTable", "TableData", "exportBrowserToExcel", FALSE)
			End Case
		End If
	End If

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUWinCreatedHandler")
	Call ERRShow()

End Sub


'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUTableOpenedHandler(ByVal args as This)

Dim	sTableName As String

OnError GoTo ErrorOccured

	Call DEBUGPrint("MENUTableOpenedHandler")
	If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
		If NumTables() = 0 Then
			Call RBNGroupEnableControls("", "", "exportTableToExcel", FALSE)
		Else
			Call RBNGroupEnableControls("", "", "exportTableToExcel", TRUE)
		End If
	End If
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUTableOpenedHandler")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUWorkspaceOpenedHandler(ByVal args as This)

OnError GoTo ErrorOccured

	Call DEBUGPrint("MENUWorkspaceOpenedHandler")
	If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
		If NumTables() = 0 Then
			Call RBNGroupEnableControls("", "", "exportTableToExcel", FALSE)
		Else
			Call RBNGroupEnableControls("", "", "exportTableToExcel", TRUE)
		End If
	End If
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUWorkspaceOpenedHandler")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUTableClosedHandler(ByVal args as This)

Dim	sTableName As String

OnError GoTo ErrorOccured

	Call DEBUGPrint("MENUTableClosedHandler")
	If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
		If NumTables() <= 1 Then
			Call RBNGroupEnableControls("", "", "exportTableToExcel", FALSE)
		Else
			Call RBNGroupEnableControls("", "", "exportTableToExcel", TRUE)
		End If
	End If
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUTableClosedHandler")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUAllClosedHandler(ByVal args as This)

OnError GoTo ErrorOccured

	Call DEBUGPrint("MENUAllClosedHandler")
	If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
		Call RBNGroupEnableControls("", "", "exportTableToExcel", FALSE)
		Call RBNGroupEnableControls("", "", "exportMapToExcel", FALSE)
		Call RBNGroupEnableControls("", "", "exportBrowserToExcel", FALSE)
	End If
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUAllClosedHandler")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub EnableDisableGUI

OnError GoTo ErrorOccured

'	Call DEBUGPrint("NumWindows: " & NumWindows())
'	Call DEBUGPrint("NumTables: " & NumTables())

	If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
		If NumWindows() = 0 Then
			Call RBNGroupEnableControls("", "", "exportMapToExcel", FALSE)
			Call RBNGroupEnableControls("", "", "exportBrowserToExcel", FALSE)
		Else
			If FrontWindow() > 0 Then
				Do Case WindowInfo(FrontWindow(), WIN_INFO_TYPE)
					Case WIN_MAPPER
						If msLatestExcelFile <> "" Then
							Call RBNGroupEnableControls("", "", "exportMapToExcel", TRUE)
						End If
						Call RBNGroupEnableControls("", "", "exportBrowserToExcel", FALSE)
					Case WIN_BROWSER
						Call RBNGroupEnableControls("", "", "exportMapToExcel", FALSE)
						Call RBNGroupEnableControls("", "", "exportBrowserToExcel", TRUE)
					Case Else
						Call RBNGroupEnableControls("", "", "exportMapToExcel", FALSE)
						Call RBNGroupEnableControls("", "", "exportBrowserToExcel", FALSE)
				End Case
			Else
				Call RBNGroupEnableControls("", "", "exportMapToExcel", FALSE)
				Call RBNGroupEnableControls("", "", "exportBrowserToExcel", FALSE)
			End If
		End If

		If NumTables() = 0 Then
			Call RBNGroupEnableControls("", "", "exportTableToExcel", FALSE)
		Else
			Call RBNGroupEnableControls("", "", "exportTableToExcel", TRUE)
		End If
	End If

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "EnableDisableGUI")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUBuildRibbonInterface

Dim	nCtrlIdx As Integer

OnError GoTo ErrorOccured

	nCtrlIdx = RBNGroupAddButton("exportTableToExcel", RESSTRNGGetString(STR_BTN_EXPORT_TABLE), "CT", "TabHome", "HomeOutput")
	If nCtrlIdx > 0 Then
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), STRINGReplace(STRINGReplace(RESSTRNGGetString(STR_MNU_EXPORT_TAB_TO_XLS), "&", ""), "...", ""), RESSTRNGGetString(STR_ERR_PLEASE_OPEN_TABLE))
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_SMALL, PATH_IMAGES & "BrowserWindowExcel_16.png", "")
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "MENUExportTableToExcel")
	End If

	nCtrlIdx = RBNGroupAddButton("exportMapToExcel", RESSTRNGGetString(STR_BTN_EXPORT_MAP), "CM", "TabHome", "HomeOutput")
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), STRINGReplace(STRINGReplace(RESSTRNGGetString(STR_MNU_EXPORT_MAP_TO_XLS), "&", ""), "...", ""), RESSTRNGGetString(STR_ERR_PLEASE_EXPORT_DATA_BEFORE_MAP))
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_SMALL, PATH_IMAGES & "MapWindowExcel_16.png", "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "MENUExportMapWindowToExcel")
	End If

	nCtrlIdx = RBNGroupAddButton("exportMapToExcel", RESSTRNGGetString(STR_BTN_EXPORT_MAP), "CM", "TabMap", "MapAnalyze")
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), STRINGReplace(STRINGReplace(RESSTRNGGetString(STR_MNU_EXPORT_MAP_TO_XLS), "&", ""), "...", ""), RESSTRNGGetString(STR_ERR_PLEASE_EXPORT_DATA_BEFORE_MAP))
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, PATH_IMAGES & "MapWindowExcel_32.png", "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "MENUExportMapWindowToExcel")
	End If

	nCtrlIdx = RBNGroupAddButton("exportBrowserToExcel", RESSTRNGGetString(STR_BTN_EXPORT_BROWSER), "CB", "TabTable", "BrowserTools")
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), STRINGReplace(STRINGReplace(RESSTRNGGetString(STR_MNU_EXPORT_BROWSER_TO_XLS), "&", ""), "...", ""), RESSTRNGGetString(STR_ERR_PLEASE_MAKE_BROWSER_ACTIVE))
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_SMALL, PATH_IMAGES & "BrowserWindowExcel_16.png", "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetLeftMarginIdx(nCtrlIdx, 0.0)
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "MENUExportBrowserDataToExcel")
	End If
	nCtrlIdx = RBNGroupInsertButtonBefore("exportTableToExcel", RESSTRNGGetString(STR_BTN_EXPORT_TABLE), "CT", "TabTable", "TableData", "ExportButton")
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), STRINGReplace(STRINGReplace(RESSTRNGGetString(STR_MNU_EXPORT_TAB_TO_XLS), "&", ""), "...", ""), RESSTRNGGetString(STR_ERR_PLEASE_OPEN_TABLE))
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_SMALL, PATH_IMAGES & "BrowserWindowExcel_16.png", "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "MENUExportTableToExcel")
	End If

	nCtrlIdx	= RBNToolContextMenuAddMenuItem("exportTableToExcel", STRINGReplace(RESSTRNGGetString(STR_MNU_EXPORT_TAB_TO_XLS), "&", ""), "")
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), STRINGReplace(STRINGReplace(RESSTRNGGetString(STR_MNU_EXPORT_TAB_TO_XLS), "&", ""), "...", ""), RESSTRNGGetString(STR_ERR_PLEASE_OPEN_TABLE))
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_SMALL, PATH_IMAGES & "BrowserWindowExcel_16.png", "")
		Call RBNControlSetLeftMarginIdx(nCtrlIdx, 0)
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "MENUExportTableToExcel")
	End If
'	nCtrlIdx	= RBNToolContextMenuAddMenuItem("rateApplication", STRINGReplace(RESSTRNGGetString(STR_MNU_RATE_APPLICATION), "&", ""), "")
'	If nCtrlIdx > 0 Then
'		'Create & Set the button tooltip
'		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), STRINGReplace(STRINGReplace(RESSTRNGGetString(STR_MNU_RATE_APPLICATION), "&", ""), "...", ""), "")
'		'Set the button icon
'		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_SMALL, PATH_IMAGES & "CommunityDownloads_16.png", "")
'		Call RBNControlSetLeftMarginIdx(nCtrlIdx, 0)
'		'Set Custom MapBasic Handle to the button
'		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "MENUGoToCommunityDownloads")
'	End If

	If NOT RBNEventSubscribe(AddInEvents_TableOpened, "MENUTableOpenedHandler") Then
		Call DEBUGPrint("MENUTableOpenedHandler was not subscribed!")
	End If
	If NOT RBNEventSubscribe(AddInEvents_TableClosed, "MENUTableClosedHandler") Then
		Call DEBUGPrint("MENUTableClosedHandler was not subscribed!")
	End If
	If NOT RBNEventSubscribe(AddInEvents_WorkspacesOpened, "MENUWorkspaceOpenedHandler") Then
		Call DEBUGPrint("MENUWorkspaceOpenedHandler was not subscribed!")
	End If
	If NOT RBNEventSubscribe(AddInEvents_CloseAllExecuted, "MENUAllClosedHandler") Then
		Call DEBUGPrint("MENUAllClosedHandler was not subscribed!")
	End If
	If NOT RBNEventSubscribe(AddInEvents_WindowCreated, "MENUWinCreatedHandler") Then
		Call DEBUGPrint("MENUWinCreatedHandler was not subscribed!")
	End If

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUBuildRibbonInterface")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUWriteConfigFile

Dim	sFile As String

OnError GoTo ErrorOccured

	sFile = GetFolderPath$(FOLDER_MI_PREFERENCE) & FILE_INI
	Call CONFIGWriteKey(sFile, "SETTINGS", "LANGUAGE_CODE", PRGIGetApplicationLanguageCode())
	Call CONFIGWriteKey(sFile, "SETTINGS", "EXCELSTARTWAITTIME", Str$(EXCELGetOpenExcelWaitTime()))

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUWriteConfigFile")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUReadConfigFile

Dim	sFile, sValue As String

OnError GoTo ErrorOccured

	sFile = GetFolderPath$(FOLDER_MI_PREFERENCE) & FILE_INI

	If FileExists(sFile) Then
		msLanguage	= CONFIGReadKey(sFile, "SETTINGS", "LANGUAGE_CODE")
		sValue		= CONFIGReadKey(sFile, "SETTINGS", "EXCELSTARTWAITTIME")
	Else
		sFile 		= ApplicationDirectory$() & FILE_INI
		msLanguage	= CONFIGReadKey(sFile, "SETTINGS", "LANGUAGE_CODE")
		sValue		= CONFIGReadKey(sFile, "SETTINGS", "EXCELSTARTWAITTIME")
	End If
	msLanguage	= RTrim$(LTrim$(msLanguage))

	If sValue = "" Then
		Call EXCELSetOpenExcelWaitTime(500)
	Else
		Call EXCELSetOpenExcelWaitTime(Val(sValue))
	End If


	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUReadConfigFile")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUGoToCommunityDownloads

OnError GoTo ErrorOccured

	Call FILELaunch("http://communitydownloads.pbinsight.com/code-exchange/download/mapinfo2excel-2.0-x64")
'	Call FILELaunch("http://communitydownloads.pbinsight.com/code-exchange/download/mapinfo2excel")
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUGoToCommunityDownloads")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Function MENUGetExcelTemplateFile() As String

OnError GoTo ErrorOccured

	MENUGetExcelTemplateFile	= ApplicationDirectory$() & "Template.xlsm"
	Exit Function
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUGetExcelTemplateFile")
	Call ERRShow()

End Function

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub AddIn_DefaultCommand

OnError GoTo ErrorOccured

	If TABGetListOfNames(TAB_USE_ALL_BUT_IMAGES, marrTables) > 0 Then
		Call MENUExportTableToExcel
	End If
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "AddIn_DefaultCommand")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUExportTableToExcel

Dim	sXLSFile As String

OnError GoTo ErrorOccured

	Redim marrTables(0)
	If TABGetListOfNames(TAB_USE_ALL_BUT_IMAGES, marrTables) = 0 Then
		If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
			Call RBNNotificationShow(xProgram, RESSTRNGGetString(STR_ERR_PLEASE_OPEN_TABLE), Notify_Error, 10000)
		Else
			Note RESSTRNGGetString(STR_ERR_PLEASE_OPEN_TABLE)		'"Please open one or more native tables!"
		End If
		Exit Sub
	End If

	sXLSFile	= DATEGetISODate(CurDate()) & " - " & DATEGetTimeAsHHMMSS(CurTime(), ".") & ".xlsm"
	If msLatestExcelFile = "" Then
		sXLSFile	= FILEAddBackSlash(GetFolderPath$(FOLDER_MYDOCS)) & sXLSFile
	Else
		sXLSFile	= PathToDirectory$(msLatestExcelFile) & sXLSFile
	End If

	Dialog
		Title  RESSTRNGGetString(STR_EXPORT_TABLE_TO_XLS)

		Control StaticText		Position 5,5	Width 300
			Title  RESSTRNGGetString(STR_SELECT_TABLE_TO_EXPORT)
		Control Listbox		Position 5,15	Width 300		Height 100	ID CTRL_LST_TABLES
			Title From Variable marrTables
			Value 1

		Control StaticText		Position 5,120	Width 300
			Title  RESSTRNGGetString(STR_XLS_OUTPUT_FILE)
		Control EditText		Position 5,130	Width 290					ID CTRL_TXT_OUTPUT_FILE
			Value sXLSFile

		Control Button			Position 295,130		Height 12	Width 10
			Title ".."
			Calling MENUExport_SaveFileAs

		Control Checkbox		Position 5,147	Width 110					ID CTRL_CHK_EXPORT_TITLES
			Title  RESSTRNGGetString(STR_EXPORT_COULMN_TITLES)
			Value mbExportTitles

		Control StaticText		Position 120,147	Width 70
			Title  RESSTRNGGetString(STR_WAIT_TIME_SECS)
		Control EditText		Position 190,145	Width 20				ID CTRL_TXT_WAIT_TIME
			Value FormatNumber$(EXCELGetOpenExcelWaitTime()/1000)


		Control OKButton		Position 220,145	Width 40
			Title  RESSTRNGGetString(STR_EXPORT)
			Calling MENUExportTableXLS_OKButton
		Control CancelButton	Position 265,145	Width 40
			Title  RESSTRNGGetString(STR_CLOSE)

	Call EnableDisableGUI
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUExportTableToExcel")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUExportTableXLS_OKButton

Dim	sNewFile, sTab As String

OnError GoTo ErrorOccured

	Dialog Preserve

	sNewFile		= ReadControlValue(CTRL_TXT_OUTPUT_FILE)
	sTab			= marrTables(ReadControlValue(CTRL_LST_TABLES))
	mbExportTitles	= ReadControlValue(CTRL_CHK_EXPORT_TITLES)

	' check selected output files is valid
	If not Right$(sNewFile,5)= Right$(MENUGetExcelTemplateFile(),5) then
		Note RESSTRNGGetString(STR_ERR_WRONG_FILE_EXTENSION) & "'" & Right$(MENUGetExcelTemplateFile(),5) & "'"
		Exit Sub
	End If

	' check selected output folder exists
	If not FileExists(PathToDirectory$(sNewFile)) then
		Note RESSTRNGGetString(STR_ERR_OUTPUT_FOLDER_NOT_FOUND)
		Exit Sub
	End If

	Call EXCELSetOpenExcelWaitTime(Val(DeformatNumber$(ReadControlValue(CTRL_TXT_WAIT_TIME)))*1000)

	Call MENUExportTableViaCSV(sTab, mbExportTitles, sNewFile)
'	Call MENUExportTableCSV(sTab, mbExportTitles, Left$(sNewFile, Len(sNewFile) - Len(FILEGetExtension(sNewFile))) & "csv")

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUExportTableXLS_OKButton")
	Call ERRShow()
	Call EXCELDDECloseChannel(nChannel)

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUExportBrowserDataToExcel

Dim	nBID As Integer,
	sXLSFile As String

OnError GoTo ErrorOccured

	nBID = FrontWindow()
	If nBID = 0 Then
		If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
			Call RBNNotificationShow(xProgram, RESSTRNGGetString(STR_ERR_PLEASE_OPEN_BROWSER), Notify_Error, 10000)
		Else
			Note RESSTRNGGetString(STR_ERR_PLEASE_OPEN_BROWSER)
		End If
		Exit Sub
	End If
	If WindowInfo(nBID, WIN_INFO_TYPE) <> WIN_BROWSER Then
		If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
			Call RBNNotificationShow(xProgram, RESSTRNGGetString(STR_ERR_PLEASE_MAKE_BROWSER_ACTIVE), Notify_Error, 10000)
		Else
			Note RESSTRNGGetString(STR_ERR_PLEASE_MAKE_BROWSER_ACTIVE)
		End If
		Exit Sub
	End If

	sXLSFile	= DATEGetISODate(CurDate()) & " - " & DATEGetTimeAsHHMMSS(CurTime(), ".") & ".xlsm"
	If msLatestExcelFile = "" Then
		Call DEBUGPrint ("GetFolderPath$(FOLDER_MYDOCS): " & GetFolderPath$(FOLDER_MYDOCS))
		Call DEBUGPrint("FILEAddBackSlash(GetFolderPath$(FOLDER_MYDOCS)): " & FILEAddBackSlash(GetFolderPath$(FOLDER_MYDOCS)))
		sXLSFile	= FILEAddBackSlash(GetFolderPath$(FOLDER_MYDOCS)) & sXLSFile
	Else
		sXLSFile	= PathToDirectory$(msLatestExcelFile) & sXLSFile
	End If

	Dialog
		Title RESSTRNGGetString(STR_EXPORT_BROWSER_DATA_TO_XLS)

		Control StaticText		Position 5,5	Width 300
			Title RESSTRNGGetString(STR_XLS_OUTPUT_FILE)
		Control EditText		Position 5,15	Width 290					ID CTRL_TXT_OUTPUT_FILE
			Value sXLSFile

		Control Button			Position 295,15		Height 12	Width 10
			Title ".."
			Calling MENUExport_SaveFileAs

		Control Checkbox		Position 5,32	Width 110					ID CTRL_CHK_EXPORT_TITLES
			Title RESSTRNGGetString(STR_EXPORT_COULMN_TITLES)
			Value mbExportTitles

		Control StaticText		Position 120,32	Width 70
			Title  RESSTRNGGetString(STR_WAIT_TIME_SECS)
		Control EditText		Position 190,30	Width 20				ID CTRL_TXT_WAIT_TIME
			Value FormatNumber$(EXCELGetOpenExcelWaitTime()/1000)


		Control OKButton		Position 220,30	Width 40
			Title RESSTRNGGetString(STR_EXPORT)
			Calling MENUExportBrowserData_OKButton
		Control CancelButton	Position 265,30	Width 40
			Title RESSTRNGGetString(STR_CLOSE)

	Call EnableDisableGUI
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUExportTableToExcel")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUExportBrowserData_OKButton

Dim	sNewFile, sTab As String

OnError GoTo ErrorOccured

	sNewFile		= ReadControlValue(CTRL_TXT_OUTPUT_FILE)
	mbExportTitles	= ReadControlValue(CTRL_CHK_EXPORT_TITLES)

	' check selected output files is valid
	If not Right$(sNewFile,5)= Right$(MENUGetExcelTemplateFile(),5) then
		Note RESSTRNGGetString(STR_ERR_WRONG_FILE_EXTENSION) & "'" & Right$(MENUGetExcelTemplateFile(),5) & "'"
		Exit Sub
	End If

	' check selected output folder exists
	If not FileExists(PathToDirectory$(sNewFile)) then
		Note RESSTRNGGetString(STR_ERR_OUTPUT_FOLDER_NOT_FOUND)
		Exit Sub
	End If

	Call EXCELSetOpenExcelWaitTime(Val(DeformatNumber$(ReadControlValue(CTRL_TXT_WAIT_TIME)))*1000)

	Create Query
		From Window FrontWindow()
		Into __dump__to__Excel

	Call MENUExportTableViaCSV("__dump__to__Excel", mbExportTitles, sNewFile)
	'Call MENUExportTableCSV("__dump__to__Excel", mbExportTitles, Left$(sNewFile, Len(sNewFile) - Len(FILEGetExtension(sNewFile))) & "csv")

	Close Table "__dump__to__Excel"

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUExportBrowserData_OKButton")
	Call ERRShow()
	Call EXCELDDECloseChannel(nChannel)

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUExport_SaveFileAs

Dim	sFile As String

OnError GoTo ErrorOccured

	sFile	= ReadControlValue(CTRL_TXT_OUTPUT_FILE)
	sFile	= FileSaveAsDlg(PathToDirectory$(sFile), PathToFileName$(sFile), "XLSM", RESSTRNGGetString(STR_ENTER_PATH_FOR_XLS_FILE))
	If sFile = "" Then
		Exit Sub
	End If

	Alter Control CTRL_TXT_OUTPUT_FILE	Value sFile

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUExport_SaveFileAs")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUExportTable(ByVal sTab As String, ByVal bExportTitles As Logical, ByVal sOutputFile As String)

Dim	sSheet, sCol, sValue As String,
	aCol As Alias,
	nChannel, nColInitial, nRowInital, nRow, nCol As Integer

OnError GoTo ErrorOccured

	Call DEBUGPrint("Validating if the file already is open")
	Do While (EXCELIsFileOpen(sOutputFile) = TRUE)
		If NOT Ask(RESSTRNGGetString(STR_ERR_XLS_FILE_OPEN)
				& lf & sOutputFile
				& lf
				& lf & RESSTRNGGetString(STR_ERR_PLEASE_CLOSE_IT_TO_CONTINUE), RESSTRNGGetString(STR_CONTINUE), RESSTRNGGetString(STR_ABORT)) Then
			Exit Sub
		End If
	Loop

	Call DEBUGPrint("Validating that the template file exists")
	If NOT FileExists(MENUGetExcelTemplateFile()) Then
		If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
			Call RBNNotificationShow(xProgram, RESSTRNGGetString(STR_ERR_XLS_TEMPL_FILE_NOT_FOUND) & lf & MENUGetExcelTemplateFile(), Notify_Error, 10000)
		Else
			Note RESSTRNGGetString(STR_ERR_XLS_TEMPL_FILE_NOT_FOUND)
						& lf & MENUGetExcelTemplateFile()
		End If
		Exit Sub
	End If

	Call DEBUGPrint("Validating that the template file isn't open'")
	Do While (EXCELIsFileOpen(MENUGetExcelTemplateFile()) = TRUE)
		If NOT Ask(RESSTRNGGetString(STR_ERR_XLS_FILE_OPEN)
				& lf & MENUGetExcelTemplateFile()
				& lf
				& lf & RESSTRNGGetString(STR_ERR_PLEASE_CLOSE_IT_TO_CONTINUE), RESSTRNGGetString(STR_CONTINUE), RESSTRNGGetString(STR_ABORT)) Then
			Exit Sub
		End If
	Loop

	Call DEBUGPrint("Saving " & MENUGetExcelTemplateFile() & " as " & sOutputFile)
	Save File MENUGetExcelTemplateFile() As sOutputFile
	If NOT EXCELOpenFile(sOutputFile) Then
		If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
			Call RBNNotificationShow(xProgram, RESSTRNGGetString(STR_ERR_OPENING_FILE) & sOutputFile, Notify_Error, 10000)
		Else
			Note RESSTRNGGetString(STR_ERR_OPENING_FILE) & sOutputFile
		End If
		Exit Function
	End If

	sSheet		= WORKSHEET_INPUT_DATA
	nColInitial	= 1
	nRowInital	= 1

	nChannel = EXCELDDEOpenChannel(sSheet)
	If nChannel = 0 Then
		If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
			Call RBNNotificationShow(xProgram, RESSTRNGGetString(STR_ERR_OPENING_DDE_CHANNEL_TO_XLS) & lf & lf & RESSTRNGGetString(STR_CHECK_EXISTENSE_OF_SHEET) & WORKSHEET_INPUT_DATA, Notify_Error, 10000)
		Else
			Note RESSTRNGGetString(STR_ERR_OPENING_DDE_CHANNEL_TO_XLS)
				& lf
				& lf & RESSTRNGGetString(STR_CHECK_EXISTENSE_OF_SHEET) & WORKSHEET_INPUT_DATA
		End If
		Exit Sub
	End If

	If bExportTitles Then
		For nCol = 1 To TableInfo(sTab, TAB_INFO_NCOLS)
			Call EXCELDDEInsertValue(nChannel, Str$(nRowInital), Str$(nColInitial + nCol - 1), ColumnInfo(sTab, "COL" & nCol, COL_INFO_NAME))
		Next

		nRowInital	= nRowInital + 1
	End If

	Fetch First From sTab
	Do Until EOT(sTab)

		For nCol = 1 To TableInfo(sTab, TAB_INFO_NCOLS)
			sCol	= ColumnInfo(sTab, "COL" + nCol, COL_INFO_NAME)
			aCol = sTab & "." & sCol

			sValue = ""

			Do Case ColumnInfo(sTab, sCol, COL_INFO_TYPE)
				Case COL_TYPE_CHAR
					sValue = aCol
				Case COL_TYPE_INTEGER, COL_TYPE_SMALLINT, COL_TYPE_LOGICAL	', COL_TYPE_LARGEINT
					sValue = Str$(aCol)
				Case COL_TYPE_FLOAT, COL_TYPE_DECIMAL
					sValue = FormatNumber$(aCol)
				Case COL_TYPE_DATE
					If aCol Then
						sValue = FormatDate$(aCol)
					End If
				Case COL_TYPE_TIME
					If aCol Then
						sValue = FormatTime$(acol, "HH:mm:ss")
					End If
				Case COL_TYPE_DATETIME
					If aCol Then
						sValue = FormatDate$(aCol) & " " & FormatTime$(GetTime(acol), "HH:mm:ss")
					End If
			End Case

			Call EXCELDDEInsertValue(nChannel, Str$(nRowInital + nRow), Str$(nColInitial + nCol - 1), sValue)
		Next

		nRow = nRow + 1
		Fetch Next From sTab
	Loop

	Call EXCELDDECloseChannel(nChannel)

	msLatestExcelFile	= sOutputFile
	mnNumMapExported	= 0

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUExportTable")
	Call ERRShow()
	Call EXCELDDECloseChannel(nChannel)

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUExportTableViaCSV(ByVal sTab As String, ByVal bExportTitles As Logical, ByVal sOutputFile As String)

Dim	sSheet, sTempFile As String,
	nChannel As Integer

OnError GoTo ErrorOccured

	Call DEBUGPrint("Validating that the file isn't already open")
	Do While (EXCELIsFileOpen(sOutputFile) = TRUE)
		If NOT Ask(RESSTRNGGetString(STR_ERR_XLS_FILE_OPEN)
				& lf & sOutputFile
				& lf
				& lf & RESSTRNGGetString(STR_ERR_PLEASE_CLOSE_IT_TO_CONTINUE), RESSTRNGGetString(STR_CONTINUE), RESSTRNGGetString(STR_ABORT)) Then
			Exit Sub
		End If
	Loop

	Call DEBUGPrint("Validating that the template file exists")
	If NOT FileExists(MENUGetExcelTemplateFile()) Then
		If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
			Call RBNNotificationShow(xProgram, RESSTRNGGetString(STR_ERR_XLS_TEMPL_FILE_NOT_FOUND) & lf & MENUGetExcelTemplateFile(), Notify_Error, 10000)
		Else
			Note RESSTRNGGetString(STR_ERR_XLS_TEMPL_FILE_NOT_FOUND)
				& lf & MENUGetExcelTemplateFile()
		End If
		Exit Sub
	End If

	Call DEBUGPrint("Validating that the template file isn't open")
	Do While (EXCELIsFileOpen(MENUGetExcelTemplateFile()) = TRUE)
		If NOT Ask(RESSTRNGGetString(STR_ERR_XLS_FILE_OPEN)
				& lf & MENUGetExcelTemplateFile()
				& lf
				& lf & RESSTRNGGetString(STR_ERR_PLEASE_CLOSE_IT_TO_CONTINUE), RESSTRNGGetString(STR_CONTINUE), RESSTRNGGetString(STR_ABORT)) Then
			Exit Sub
		End If
	Loop

	Call DEBUGPrint("Saving " & MENUGetExcelTemplateFile() & " as " & sOutputFile)
	Save File MENUGetExcelTemplateFile() As sOutputFile
	If NOT EXCELOpenFile(sOutputFile) Then
		If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
			Call RBNNotificationShow(xProgram, RESSTRNGGetString(STR_ERR_OPENING_FILE) & sOutputFile, Notify_Error, 10000)
		Else
			Note RESSTRNGGetString(STR_ERR_OPENING_FILE) & sOutputFile
		End If
		Exit Function
	End If

	If SystemInfo(SYS_INFO_MIVERSION) >= 1520 Then
		sTempFile	= PathToDirectory$(sOutputFile) & "MapInfo2Excel_Dump.csv"
	Else
		sTempFile	= PathToDirectory$(TempFileName$("")) & "MapInfo2Excel_Dump.csv"
	End If

	Call MENUExportTableCSV(sTab, mbExportTitles, sTempFile)

	sSheet		= WORKSHEET_INPUT_DATA

	nChannel = EXCELDDEOpenChannel(sSheet)
	If nChannel = 0 Then
		If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
			Call RBNNotificationShow(xProgram, RESSTRNGGetString(STR_ERR_OPENING_DDE_CHANNEL_TO_XLS) & lf & lf & RESSTRNGGetString(STR_CHECK_EXISTENSE_OF_SHEET) & WORKSHEET_INPUT_DATA, Notify_Error, 10000)
		Else
			Note RESSTRNGGetString(STR_ERR_OPENING_DDE_CHANNEL_TO_XLS)
				& lf
				& lf & RESSTRNGGetString(STR_CHECK_EXISTENSE_OF_SHEET) & WORKSHEET_INPUT_DATA
		End If
		Exit Sub
	End If

	Call DEBUGPrint("Sending file name to Excel: " & sTempFile)
	Call EXCELDDEInsertValue(nChannel, Str$(1), Str$(1), sTempFile)
	Call EXCELDDECloseChannel(nChannel)

	Call DEBUGPrint("Running import macro in Excel")
	Call EXCELDDEExecuteMacro(sOutputFile, "ImportMIData")

	Call DEBUGPrint("Deleting CSV file")
	If FileExists(sTempFile) then
		Kill sTempFile
	End If

	msLatestExcelFile	= sOutputFile
	mnNumMapExported	= 0

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUExportTableViaCSV")
	Call ERRShow()
	Call EXCELDDECloseChannel(nChannel)

End Sub


'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUExportTableCSV(ByVal sTab As String, ByVal bExportTitles As Logical, ByVal sOutputFile As String)

Dim	sCmd, sExpr, sCol As String,
	nErr, nCol As Integer

OnError GoTo ErrorOccured

	Call DEBUGPrint("Saving table " & sTab & " into " & sOutputFile)

	Fetch First From sTab
	For nCol = 1 To TableInfo(sTab, TAB_INFO_NCOLS)
		sCol	= ColumnInfo(sTab, "COL" + nCol, COL_INFO_NAME)

		Do Case ColumnInfo(sTab, sCol, COL_INFO_TYPE)
			Case COL_TYPE_CHAR
				sExpr = sCol
			Case COL_TYPE_INTEGER, COL_TYPE_SMALLINT, COL_TYPE_LOGICAL	', COL_TYPE_LARGEINT
				sExpr = "Str$(" & sCol & ")"
			Case COL_TYPE_FLOAT, COL_TYPE_DECIMAL
				sExpr = "FormatNumber$(" & sCol & ")"
			Case COL_TYPE_DATE
				sExpr = "FormatDate$(" & sCol & ")"
			Case COL_TYPE_TIME
				sExpr = "FormatTime$(" & sCol & ", " & eye & "HH:mm:ss" & eye & ")"
			Case COL_TYPE_DATETIME
				sExpr = "FormatDate$(" & sCol & ") + " + eye + " " + eye + " + FormatTime$(" & sCol & ", " & eye & "HH:mm:ss" & eye & ")"
		End Case

		If sCmd = "" Then
			sCmd	= sExpr & " " & eye & sCol & eye
		Else
			sCmd = sCmd & ", " & sExpr & " " & eye & sCol & eye
		End If

	Next

	sCmd = "Select " & sCmd & " From " & sTab & " Into __TO__EXPORT__CSV NoSelect"
	Call DEBUGPrint("sCmd: " & sCmd)
	Run Command sCmd

	Call DEBUGPrint("Exporting to CSV file: " & TableInfo("__TO__EXPORT__CSV", TAB_INFO_NROWS) & " rows")
	If bExportTitles Then
		Export __TO__EXPORT__CSV
			Into sOutputFile
			Type "ASCII"
				Charset SystemInfo(SYS_INFO_CHARSET)
				Delimiter ";"
				Titles
			Overwrite
	Else
		Export __TO__EXPORT__CSV
			Into sOutputFile
			Type "ASCII"
				Charset SystemInfo(SYS_INFO_CHARSET)
				Delimiter ";"
			Overwrite
	End If

	Close Table __TO__EXPORT__CSV
	Call DEBUGPrint("Export done")

	Exit Sub
'-------------------------
ErrorOccured:
	nErr = Err()
	Call ERRCreate(nErr, Error$(), "MENUExportTableCSV")
	If nErr = 305 Then
		Call ERRPrint()
		Resume Next
	Else
		Call ERRShow()
	End If

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub MENUExportMapWindowToExcel

Dim	bWinWasResized As Logical,
	sFile, sSheet, sImageCell As String,
	nMID, nChannel, nColInitial, nRowInital As Integer

OnError GoTo ErrorOccured

	Call DEBUGPrint("Validating latest file")
	If msLatestExcelFile = "" Then
		If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
			Call RBNNotificationShow(xProgram, RESSTRNGGetString(STR_ERR_PLEASE_EXPORT_DATA_BEFORE_MAP), Notify_Error, 10000)
		Else
			Note RESSTRNGGetString(STR_ERR_PLEASE_EXPORT_DATA_BEFORE_MAP)
		End If
		Exit Sub
	End If

	Call DEBUGPrint("Validating frontmost map window")
	nMID = MAPFrontMostWindow()
	If nMID = 0 Then
		If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
			Call RBNNotificationShow(xProgram, RESSTRNGGetString(STR_ERR_PLEASE_OPEN_A_MAP), Notify_Error, 10000)
		Else
			Note RESSTRNGGetString(STR_ERR_PLEASE_OPEN_A_MAP)
		End If
		Exit Sub
	End If

	Call DEBUGPrint("Validating Excel file is open")
	If NOT EXCELIsFileOpen(msLatestExcelFile) Then
		If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_RIBBON Then
			Call RBNNotificationShow(xProgram, RESSTRNGGetString(STR_ERR_LATEST_XLS_FILE_NOT_OPEN), Notify_Error, 10000)
		Else
			Note RESSTRNGGetString(STR_ERR_LATEST_XLS_FILE_NOT_OPEN)
		End If
		msLatestExcelFile	= ""
		mnNumMapExported	= 0
		Exit Sub
	End If

	Call DEBUGPrint("Creating image file")
	sFile	= PathToDirectory$(msLatestExcelFile) & "MapWindow.jpg"
	Save Window nMID
		As sFile
		Type "JPEG"
		'Width 15 Units "cm"
		'Height 15 Units "cm"
		Resolution 150

	Call DEBUGPrint("Exported Map Window (" & (mnNumMapExported + 1) & ") into file " & sFile)

	sSheet		= WORKSHEET_INPUT_MAPS
	nColInitial	= 2
	nRowInital	= 2

	nChannel = EXCELDDEOpenChannel(sSheet)
	If nChannel = 0 Then
		Note RESSTRNGGetString(STR_ERR_OPENING_DDE_CHANNEL_TO_XLS)
			& lf
			& lf & RESSTRNGGetString(STR_CHECK_EXISTENSE_OF_SHEET) & WORKSHEET_INPUT_MAPS
		Exit Sub
	End If

	sImageCell = Chr$((Asc("A") - 1) + nColInitial) & Str$(nRowInital + (mnNumMapExported * 20))

	Call EXCELDDEInsertValue(nChannel, "1", "1", sImageCell)
	Call EXCELDDEInsertValue(nChannel, "1", "2", sFile)
	Call EXCELDDECloseChannel(nChannel)

	Call EXCELDDEExecuteMacro(msLatestExcelFile, "ImportImage")

	mnNumMapExported	= mnNumMapExported + 1

	Kill sFile

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUExportMapWindowToExcel")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'	:
'Return value:
'
'**********************************************************************************************''
Function MENUExportMapToExcelIsEnabled() As Logical

OnError GoTo ErrorOccured

	MENUExportMapToExcelIsEnabled = (msLatestExcelFile <> "")
	Exit Function
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "MENUExportMapToExcelIsEnabled")
	Call ERRShow()

End Function

